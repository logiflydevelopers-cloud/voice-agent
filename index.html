<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voice AI Call</title>

<style>
body{
  background:#0f172a;
  color:#fff;
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.box{
  background:#020617;
  width:360px;
  padding:25px;
  border-radius:14px;
  text-align:center;
}
button{
  width:100%;
  padding:16px;
  font-size:18px;
  border:none;
  border-radius:40px;
  cursor:pointer;
}
.start{background:#22c55e;}
.stop{background:#ef4444;color:#fff;}
.status{margin-top:10px;opacity:.8;}
</style>
</head>

<body>
<div class="box">
  <h3>üéß Voice AI Call</h3>
  <button id="btn" class="start">üé§ Speak</button>
  <div id="status" class="status">Idle</div>
</div>

<script>
/* ================= CONFIG ================= */
const WEBHOOK_URL = "https://newsworld.app.n8n.cloud/webhook/voice-agent";
const SILENCE_THRESHOLD = 0.02;
const SILENCE_TIME = 1200;

/* ================= STATE ================= */
let state = "IDLE"; // IDLE | ARMED | RECORDING | THINKING
let micStream = null;
let audioCtx = null;
let analyser = null;
let recorder = null;
let chunks = [];
let silenceStart = null;

/* detector */
let detectorStream = null;
let detectorCtx = null;
let detectorAnalyser = null;
let detectorRunning = false;

/* ai audio */
let aiAudio = null;

/* ================= UI ================= */
const btn = document.getElementById("btn");
const status = document.getElementById("status");

/* ================= START RECORDING ================= */
async function startRecording(){
  if (state !== "ARMED") return;

  stopDetector();                 // üî¥ ensure detector mic off
  state = "RECORDING";
  status.innerText = "Listening...";

  micStream = await navigator.mediaDevices.getUserMedia({ audio:true });
  audioCtx = new AudioContext();
  const src = audioCtx.createMediaStreamSource(micStream);

  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  src.connect(analyser);

  recorder = new MediaRecorder(micStream);
  chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = sendToWebhook;

  recorder.start();
  silenceStart = null;

  detectSilence();
}

/* ================= STOP RECORDING ================= */
function stopRecording(){
  if (state !== "RECORDING") return;

  state = "THINKING";
  status.innerText = "Thinking...";

  try { recorder.stop(); } catch {}

  if (micStream){
    micStream.getTracks().forEach(t=>t.stop());
    micStream = null;
  }

  if (audioCtx){
    audioCtx.close();
    audioCtx = null;
  }

  analyser = recorder = null;
}

/* ================= SILENCE DETECTION ================= */
function detectSilence(){
  const data = new Uint8Array(analyser.fftSize);

  function loop(){
    if (state !== "RECORDING") return;

    analyser.getByteTimeDomainData(data);
    let sum = 0;
    for (let i=0;i<data.length;i++){
      const v=(data[i]-128)/128;
      sum+=v*v;
    }
    const volume = Math.sqrt(sum/data.length);

    if (volume < SILENCE_THRESHOLD){
      if (!silenceStart) silenceStart = Date.now();
      if (Date.now()-silenceStart > SILENCE_TIME){
        stopRecording();          // üîá user stopped
        return;
      }
    } else silenceStart = null;

    requestAnimationFrame(loop);
  }
  loop();
}

/* ================= SEND TO N8N ================= */
async function sendToWebhook(){
  if (chunks.length === 0){
    state = "ARMED";
    status.innerText = "Waiting for user...";
    startDetector();
    return;
  }

  const blob = new Blob(chunks,{type:"audio/webm"});
  chunks = [];

  const fd = new FormData();
  fd.append("audio",blob,"voice.webm");

  const res = await fetch(WEBHOOK_URL,{method:"POST",body:fd});
  if (!res.ok){
    state = "ARMED";
    status.innerText = "Waiting for user...";
    startDetector();
    return;
  }

  const buffer = await res.arrayBuffer();
  aiAudio = new Audio(URL.createObjectURL(new Blob([buffer])));

  status.innerText = "Replying...";
  await aiAudio.play();

  aiAudio.onended = ()=>{
    aiAudio = null;
    state = "ARMED";
    status.innerText = "Waiting for user...";
    startDetector();
  };
}

/* ================= VOICE DETECTOR ================= */
async function startDetector(){
  if (detectorRunning || state !== "ARMED") return;

  detectorRunning = true;
  detectorStream = await navigator.mediaDevices.getUserMedia({ audio:true });
  detectorCtx = new AudioContext();
  const src = detectorCtx.createMediaStreamSource(detectorStream);

  detectorAnalyser = detectorCtx.createAnalyser();
  detectorAnalyser.fftSize = 2048;
  src.connect(detectorAnalyser);

  const data = new Uint8Array(detectorAnalyser.fftSize);

  function detect(){
    if (!detectorRunning || state !== "ARMED") return;

    detectorAnalyser.getByteTimeDomainData(data);
    let sum=0;
    for(let i=0;i<data.length;i++){
      const v=(data[i]-128)/128;
      sum+=v*v;
    }
    const volume=Math.sqrt(sum/data.length);

    if (volume > SILENCE_THRESHOLD){
      startRecording(); // üé§ user speaks
      return;
    }
    requestAnimationFrame(detect);
  }
  detect();
}

/* ================= STOP DETECTOR ================= */
function stopDetector(){
  detectorRunning = false;

  if (detectorStream){
    detectorStream.getTracks().forEach(t=>t.stop());
    detectorStream = null;
  }
  if (detectorCtx){
    detectorCtx.close();
    detectorCtx = null;
  }
  detectorAnalyser = null;
}

/* ================= HARD STOP EVERYTHING ================= */
function hardStopAll(){
  state = "IDLE";

  stopDetector();

  if (recorder){
    try { recorder.stop(); } catch {}
    recorder = null;
  }

  if (micStream){
    micStream.getTracks().forEach(t=>t.stop());
    micStream = null;
  }

  if (audioCtx){
    audioCtx.close();
    audioCtx = null;
  }

  if (aiAudio){
    aiAudio.pause();
    aiAudio.src = "";
    aiAudio = null;
  }
}

/* ================= BUTTON ================= */
btn.onclick = ()=>{
  if (state === "IDLE"){
    state = "ARMED";
    btn.innerText="‚èπ Stop";
    btn.className="stop";
    status.innerText="Waiting for user...";
    startDetector();
  } else {
    btn.innerText="üé§ Speak";
    btn.className="start";
    status.innerText="Idle";
    hardStopAll();     // üî• FULL MIC SHUTDOWN
  }
};
</script>
</body>
</html>
